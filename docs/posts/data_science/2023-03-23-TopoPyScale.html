<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.262">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Me">
<meta name="dcterms.date" content="2023-03-23">
<meta name="description" content="Downscaling climate data based on topography.">

<title>Envinformatics - TopoPyScale</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../hmbnnblog-logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Envinformatics - TopoPyScale">
<meta property="og:description" content="Downscaling climate data based on topography.">
<meta property="og:image" content="images/downscale.jpeg">
<meta property="og:site-name" content="Envinformatics">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Envinformatics</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="dropdown-header">
 <span class="menu-text">Index</span></li>
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">TopoPyScale</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Geospatial</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/geospatial/2021-03-25-address_urls_geodatabase.html" class="sidebar-item-text sidebar-link">Geospatial Data Address</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/geospatial/2021-07-03-Learning-GIS-RS.html" class="sidebar-item-text sidebar-link">GIS &amp; RS learning and notes</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Explanations</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/explanations/2021-03-01_create_blog.html" class="sidebar-item-text sidebar-link">Blogging with Quarto</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/explanations/2021-06-07-My-Notes-Jupyterlab.html" class="sidebar-item-text sidebar-link">Jupyterlab</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/explanations/2021-07-02-ML-Resources.html" class="sidebar-item-text sidebar-link">ML-DL Resources</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/explanations/2022-09-30-My-Notes-Ubuntu.html" class="sidebar-item-text sidebar-link">Ubuntu</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Analysis Methods</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/analysis_methods/2021-08-26-Anaysis_Process_Merra2.html" class="sidebar-item-text sidebar-link">Analysis process of downscaled MERRA-2 data</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/data_science/2023-02-08-Geospatial_ML_DL.html" class="sidebar-item-text sidebar-link">GepSpatial ML-DL Sources</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/data_science/2022-11-11-Scraping_AQI.html" class="sidebar-item-text sidebar-link">Scraping AQI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/data_science/2023-03-23-TopoPyScale.html" class="sidebar-item-text sidebar-link active">TopoPyScale</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#very-important-note" id="toc-very-important-note" class="nav-link" data-scroll-target="#very-important-note">Very Important Note:</a>
  <ul>
  <li><a href="#to-run-topopyscale-you-must-in-python-3.9-environment." id="toc-to-run-topopyscale-you-must-in-python-3.9-environment." class="nav-link" data-scroll-target="#to-run-topopyscale-you-must-in-python-3.9-environment.">To run TopoPyScale you must in python 3.9 environment.</a></li>
  <li><a href="#python-environment-preparation" id="toc-python-environment-preparation" class="nav-link" data-scroll-target="#python-environment-preparation">1- Python Environment Preparation</a></li>
  <li><a href="#release-installation" id="toc-release-installation" class="nav-link" data-scroll-target="#release-installation">2- Release Installation</a></li>
  <li><a href="#setting-up-cdsapi" id="toc-setting-up-cdsapi" class="nav-link" data-scroll-target="#setting-up-cdsapi">3- Setting up <code>cdsapi</code></a>
  <ul>
  <li><a href="#config-file" id="toc-config-file" class="nav-link" data-scroll-target="#config-file">3-1- Config File</a></li>
  <li><a href="#install-cdsapi" id="toc-install-cdsapi" class="nav-link" data-scroll-target="#install-cdsapi">3-2- Install cdsapi</a></li>
  <li><a href="#testing-download-climate-data" id="toc-testing-download-climate-data" class="nav-link" data-scroll-target="#testing-download-climate-data">3-3- Testing download climate data</a></li>
  </ul></li>
  <li><a href="#create-your-project-directory" id="toc-create-your-project-directory" class="nav-link" data-scroll-target="#create-your-project-directory">4- Create your project directory</a></li>
  <li><a href="#create-config-file" id="toc-create-config-file" class="nav-link" data-scroll-target="#create-config-file">5- Create Config file</a></li>
  <li><a href="#run-codes" id="toc-run-codes" class="nav-link" data-scroll-target="#run-codes">6- Run codes</a></li>
  </ul></li>
  <li><a href="#important-note" id="toc-important-note" class="nav-link" data-scroll-target="#important-note">Important Note:</a>
  <ul>
  <li><a href="#convert-hourly-to-yearly-data" id="toc-convert-hourly-to-yearly-data" class="nav-link" data-scroll-target="#convert-hourly-to-yearly-data">7- Convert <code>Hourly</code> to <code>Yearly</code> data</a></li>
  <li><a href="#adding-coordinate-dimention-to-results" id="toc-adding-coordinate-dimention-to-results" class="nav-link" data-scroll-target="#adding-coordinate-dimention-to-results">8- Adding Coordinate dimention to results</a></li>
  <li><a href="#saving-reult-to-netcdf-file" id="toc-saving-reult-to-netcdf-file" class="nav-link" data-scroll-target="#saving-reult-to-netcdf-file">9- Saving reult to netcdf file</a></li>
  <li><a href="#extract-temperature-from-dataframe" id="toc-extract-temperature-from-dataframe" class="nav-link" data-scroll-target="#extract-temperature-from-dataframe">10- Extract <code>Temperature</code> from dataframe</a></li>
  <li><a href="#save-a-variable-to-geotif-file" id="toc-save-a-variable-to-geotif-file" class="nav-link" data-scroll-target="#save-a-variable-to-geotif-file">11- Save a variable to geotif file</a></li>
  </ul></li>
  <li><a href="#note" id="toc-note" class="nav-link" data-scroll-target="#note">Note:</a></li>
  <li><a href="#run-topopyscale-in-colab" id="toc-run-topopyscale-in-colab" class="nav-link" data-scroll-target="#run-topopyscale-in-colab">Run TopoPyScale in Colab</a>
  <ul>
  <li><a href="#mount-the-google-drive" id="toc-mount-the-google-drive" class="nav-link" data-scroll-target="#mount-the-google-drive">Mount the google drive</a></li>
  <li><a href="#create-a-virtual-environment-using-virtualenv-library" id="toc-create-a-virtual-environment-using-virtualenv-library" class="nav-link" data-scroll-target="#create-a-virtual-environment-using-virtualenv-library">Create a virtual environment using virtualenv library</a></li>
  <li><a href="#activate-the-environment" id="toc-activate-the-environment" class="nav-link" data-scroll-target="#activate-the-environment">Activate the environment</a></li>
  <li><a href="#install-packages" id="toc-install-packages" class="nav-link" data-scroll-target="#install-packages">Install Packages</a></li>
  <li><a href="#test-package" id="toc-test-package" class="nav-link" data-scroll-target="#test-package">Test Package</a></li>
  <li><a href="#setting-up-cdsapi-1" id="toc-setting-up-cdsapi-1" class="nav-link" data-scroll-target="#setting-up-cdsapi-1">Setting up cdsapi</a></li>
  <li><a href="#running-topopyscale-in-colab" id="toc-running-topopyscale-in-colab" class="nav-link" data-scroll-target="#running-topopyscale-in-colab">Running TopoPyScale in Colab</a></li>
  <li><a href="#local-google-drive" id="toc-local-google-drive" class="nav-link" data-scroll-target="#local-google-drive">Local Google Drive</a>
  <ul>
  <li><a href="#access-google-drive-using-graphical-user-interface" id="toc-access-google-drive-using-graphical-user-interface" class="nav-link" data-scroll-target="#access-google-drive-using-graphical-user-interface">Access Google Drive Using Graphical-User-Interface</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#downscaling-for-large-area-and-big-data" id="toc-downscaling-for-large-area-and-big-data" class="nav-link" data-scroll-target="#downscaling-for-large-area-and-big-data">Downscaling for large area and big data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">TopoPyScale</h1>
  <div class="quarto-categories">
    <div class="quarto-category">GeoSpatial</div>
    <div class="quarto-category">Downscale</div>
    <div class="quarto-category">Climate</div>
  </div>
  </div>

<div>
  <div class="description">
    Downscaling climate data based on topography.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Me </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 23, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p><strong>TopoPyScale</strong> is a downscaling toolbox for globmal and regional climate model datasets, particularly relevant to mountain ranges, and hillslopes.</p>
<p>src: https://topopyscale.readthedocs.io/en/latest/m</p>
<p><code>TopoPyScale</code> uses both climate model data and Digital Elevation Models (DEM) for correcting atmospheric state variables (e.g.&nbsp;temperature, pressure, humidity, etc). TopoPyScale provides tools to interpolate and correct such variables to be relevant locally given a topographical context.</p>
<p>The most basic requirements of TopoPyScale is a DEM used to defined the spatial domain of interest as well as compute a number of morphometrics, and configuration file defining the temporal period, the downscaling methods and other parameters. In its current version, <code>TopoPyScale</code> includes the <code>topoclass</code> class that wraps all functionalities for ease of use. It automatically fetches data from the <a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels?tab=overview">ERA5</a> repositories (Pressure and Surface levels). Other climate data sources can be added. Based on the high resolution (30-100m) DEM and the climate data, methods in the <code>topoclass</code> will compute, correct and interpolate variables need to force specialized land-surface models.</p>
<p>Indeed, with this library you can download hourly ERA5 climate data and the downscale them in desires spatial resolution.</p>
<p>Downscaled variable includes:</p>
<pre><code>2m air temperature
2m air humidity
2m air pressure
10m wind speed and direction
Surface incoming shortwave radiation
Surface incoming longwave radiation
Precipitation (possibility to partition snow and rain)</code></pre>
<p>In the following, you can done downscaling climate data step-by-step.</p>
</section>
<section id="very-important-note" class="level2">
<h2 class="anchored" data-anchor-id="very-important-note">Very Important Note:</h2>
<section id="to-run-topopyscale-you-must-in-python-3.9-environment." class="level3">
<h3 class="anchored" data-anchor-id="to-run-topopyscale-you-must-in-python-3.9-environment.">To run TopoPyScale you must in python 3.9 environment.</h3>
</section>
<section id="python-environment-preparation" class="level3">
<h3 class="anchored" data-anchor-id="python-environment-preparation">1- Python Environment Preparation</h3>
<p>TopoPyScale is tested for <code>Python 3.9</code>. You may create a new virtual environment using conda prior to installation.</p>
<pre><code>conda create -n downscaling python=3.9 ipython
conda activate downscaling</code></pre>
<p>For install dependencies use <code>mamba</code> instead <code>conda</code>:</p>
<pre><code>mamba install xarray matplotlib scikit-learn pandas numpy netcdf4 h5netcdf rasterio pyproj dask</code></pre>
</section>
<section id="release-installation" class="level3">
<h3 class="anchored" data-anchor-id="release-installation">2- Release Installation</h3>
<pre><code>pip install topopyscale</code></pre>
</section>
<section id="setting-up-cdsapi" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-cdsapi">3- Setting up <code>cdsapi</code></h3>
<p>Then you need to setup your <code>cdsapi</code> with the Copernicus API key system. After after creating an account with <a href="https://cds.climate.copernicus.eu/">Copernicus</a>, use following step for setting up to download EAR5 data.</p>
<section id="config-file" class="level4">
<h4 class="anchored" data-anchor-id="config-file">3-1- Config File</h4>
<p>On Linux, create a file gedit <code>~/.cdsapirc</code> or <code>$HOME/.cdsapirc</code> with inside:</p>
<pre><code>url: https://cds.climate.copernicus.eu/api/v2
key: 2609:a8a3aba4-af46-4f7a-a79b-5799b58def50</code></pre>
</section>
<section id="install-cdsapi" class="level4">
<h4 class="anchored" data-anchor-id="install-cdsapi">3-2- Install cdsapi</h4>
<pre><code>pip install cdsapi</code></pre>
</section>
<section id="testing-download-climate-data" class="level4">
<h4 class="anchored" data-anchor-id="testing-download-climate-data">3-3- Testing download climate data</h4>
<p>In jupyterlab cell:</p>
<pre><code>import cdsapi
c = cdsapi.Client()
c.retrieve("reanalysis-era5-pressure-levels",
{
"variable": "temperature",
"pressure_level": "1000",
"product_type": "reanalysis",
"year": "2008",
"month": "01",
"day": "01",
"time": "12:00",
"format": "grib"
}, "download.grib")</code></pre>
</section>
</section>
<section id="create-your-project-directory" class="level3">
<h3 class="anchored" data-anchor-id="create-your-project-directory">4- Create your project directory</h3>
<p>Folders and files in your project directory must be as follow: Note: <code>inputs</code>, <code>dem</code> amd <code>config.yml</code> files are mandatory</p>
<pre><code>my_project/
    ├── inputs/
        ├── dem/ 
            ├── my_dem.tif
            └── pts_list.csv  (OPTIONAL: to downscale to specific points)
        └── climate/
            ├── PLEV*.nc
            └── SURF*.nc
    ├── outputs/
            ├── tmp/
    ├── pipeline.py (OPTIONAL: script for the downscaling instructions)
    └── config.yml</code></pre>
</section>
<section id="create-config-file" class="level3">
<h3 class="anchored" data-anchor-id="create-config-file">5- Create Config file</h3>
<p>Create <code>config.yml</code> file in project directory with inside for example:</p>
<pre><code>project:
    name: Khaeiz
    description: Downscaling for the Khaeiz mountains
    authors:
        - Madadi H.
    date: March 2023
    directory: /mnt/864424144424098F/Anaconda_Projects/Climate_DownScale/Caracal/Topopyscale_prj_khaeiz/
    start: 2020-01-01
    end: 2020-12-31
    split:
        IO: False
        time: 1  # run indivudal batch in time
        space: None  # to be implemented
    extent: 
    CPU_cores: 4
    climate: era5

climate:
    era5:
        path: inputs/climate/
        product: reanalysis
        timestep: 1H
        plevels: [700,750,800,850,900,950,1000]
        download_threads: 12

dem:
    file: srtm_47_06_z39_khaeiz.tif
    epsg: 32639
    horizon_increments: 10

sampling:
    method: toposub


    toposub:
        clustering_method: minibatchkmean
        n_clusters: 50
        random_seed: 2
        clustering_features: {'x':1, 'y':1, 'elevation':4, 'slope':1, 'aspect_cos':1, 'aspect_sin':1, 'svf':1}


toposcale:
    interpolation_method: idw
    pt_sampling_method: nearest
    LW_terrain_contribution: True

outputs:
    variables: all  # list or combination name
    file:
        clean_outputs: True
        clean_FSM: True
        df_centroids: df_centroids.pck
        ds_param: ds_param.nc
        ds_solar: ds_solar.nc
        da_horizon: da_horizon.nc
        landform: landform.tif
        downscaled_pt: down_pt_*.nc</code></pre>
</section>
<section id="run-codes" class="level3">
<h3 class="anchored" data-anchor-id="run-codes">6- Run codes</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize Number of Clusters</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> TopoPyScale <span class="im">import</span> topoclass <span class="im">as</span> tc</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>config_file <span class="op">=</span> <span class="st">'/mnt/864424144424098F/Anaconda_Projects/Climate_DownScale/Caracal/Topopyscale_prj_khaeiz/config.yml'</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>mp <span class="op">=</span> tc.Topoclass(config_file)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>mp.compute_dem_param()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> mp.search_optimum_number_of_clusters(cluster_range<span class="op">=</span>np.arange(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">50</span>),plot<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> TopoPyScale <span class="im">import</span> topoclass <span class="im">as</span> tc</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========= STEP 1 ==========</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Configuration</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>config_file <span class="op">=</span> <span class="st">'/mnt/864424144424098F/Anaconda_Projects/Climate_DownScale/Caracal/Topopyscale_prj_khaeiz/config.yml'</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>mp <span class="op">=</span> tc.Topoclass(config_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ======== STEP 2 ===========</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute parameters of the DEM (slope, aspect, sky view factor)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>mp.compute_dem_param()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>mp.extract_topo_param()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ----- Option 1:</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute clustering of the input DEM and extract cluster centroids</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#mp.extract_dem_cluster_param()</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>mp.extract_topo_cluster_param()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot clusters</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>mp.toposub.plot_clusters_map()</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot sky view factor</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>mp.toposub.plot_clusters_map(var<span class="op">=</span><span class="st">'svf'</span>, cmap<span class="op">=</span>plt.cm.viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========= STEP 3 ==========</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># compute solar geometry and horizon angles</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>mp.compute_solar_geometry()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>mp.compute_horizon()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="important-note" class="level2">
<h2 class="anchored" data-anchor-id="important-note">Important Note:</h2>
<p>In input folder only <code>surf</code> and <code>PLEV</code> files must be coresponding to <code>start date</code> and <code>end date</code> in config file, otherwise below code encounter with <code>memory error</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========= STEP 4 ==========</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform the downscaling</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>mp.downscale_climate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========= STEP 5 ==========</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Export output to desired format</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>mp.to_netcdf()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="convert-hourly-to-yearly-data" class="level3">
<h3 class="anchored" data-anchor-id="convert-hourly-to-yearly-data">7- Convert <code>Hourly</code> to <code>Yearly</code> data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ds_down_dsk <span class="op">=</span> xr.open_dataset(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"./Caracal/Topopyscale_prj_khaeiz/outputs/output.nc"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    chunks<span class="op">=</span>{<span class="st">"point_id"</span>: <span class="dv">10</span>}</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>ds_down_dsk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ds_year <span class="op">=</span> ds_down_dsk.groupby(<span class="st">'time.year'</span>).mean(<span class="st">'time'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-coordinate-dimention-to-results" class="level3">
<h3 class="anchored" data-anchor-id="adding-coordinate-dimention-to-results">8- Adding Coordinate dimention to results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ds_param <span class="op">=</span> xr.open_dataset(<span class="st">"./Caracal/Topopyscale_prj_khaeiz/outputs/ds_param.nc"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ds_param</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ds_khaeiz <span class="op">=</span> ds_year.sel(point_id<span class="op">=</span>ds_param.cluster_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="saving-reult-to-netcdf-file" class="level3">
<h3 class="anchored" data-anchor-id="saving-reult-to-netcdf-file">9- Saving reult to netcdf file</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_scaling_and_offset(da, n<span class="op">=</span><span class="dv">16</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute offset and scale factor for int conversion</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">        da (dataarray): of a given variable</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">        n (int): number of digits to account for</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    vmin <span class="op">=</span> <span class="bu">float</span>(da.<span class="bu">min</span>().values)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    vmax <span class="op">=</span> <span class="bu">float</span>(da.<span class="bu">max</span>().values)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># stretch/compress data to the available packed range</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    scale_factor <span class="op">=</span> (vmax <span class="op">-</span> vmin) <span class="op">/</span> (<span class="dv">2</span> <span class="op">**</span> n <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># translate the range to be symmetric about zero</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    add_offset <span class="op">=</span> vmin <span class="op">+</span> <span class="dv">2</span> <span class="op">**</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> scale_factor</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scale_factor, add_offset</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_netcdf(ds, fname<span class="op">=</span><span class="st">'output.nc'</span>, variables<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Generic function to save a datatset to one single compressed netcdf file</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co">            fname (str): name of export file</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co">            variables (list str): list of variable to export. Default exports all variables</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        encod_dict <span class="op">=</span> {}</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> variables <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>            variables <span class="op">=</span> <span class="bu">list</span>(ds.keys())</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> variables:</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            scale_factor, add_offset <span class="op">=</span> compute_scaling_and_offset(ds[var], n<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">str</span>(ds[var].dtype)[:<span class="dv">3</span>] <span class="op">==</span> <span class="st">'int'</span>:</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>                encod_dict.update({var:{</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">'dtype'</span>:ds[var].dtype}})</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>                encod_dict.update({var:{<span class="st">"zlib"</span>: <span class="va">True</span>,</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"complevel"</span>: <span class="dv">9</span>,</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'dtype'</span>:<span class="st">'int16'</span>,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'scale_factor'</span>:scale_factor,</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'add_offset'</span>:add_offset}})</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        ds[variables].to_netcdf(fname, encoding<span class="op">=</span>encod_dict, engine<span class="op">=</span><span class="st">'h5netcdf'</span>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'---&gt; File </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss"> saved'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>to_netcdf(ds_khaeiz, fname<span class="op">=</span><span class="st">'downscaled_nc.nc'</span>, variables<span class="op">=</span><span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extract-temperature-from-dataframe" class="level3">
<h3 class="anchored" data-anchor-id="extract-temperature-from-dataframe">10- Extract <code>Temperature</code> from dataframe</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ds_t <span class="op">=</span> ds_khaeiz.t</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>ds_t.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="save-a-variable-to-geotif-file" class="level3">
<h3 class="anchored" data-anchor-id="save-a-variable-to-geotif-file">11- Save a variable to geotif file</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyproj <span class="im">import</span> CRS</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>xds <span class="op">=</span> xarray.open_dataset(<span class="st">"downscaled_nc.nc"</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>bT <span class="op">=</span> xds[<span class="st">'t'</span>]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>bT <span class="op">=</span> bT.rio.set_spatial_dims(x_dim<span class="op">=</span><span class="st">'x'</span>, y_dim<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>bT.rio.crs</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the CRS projection</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>bT.rio.write_crs(<span class="st">"epsg:32639"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the GeoTIFF file: </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>bT.rio.to_raster(<span class="vs">r"temp_raster.tiff"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="note" class="level2">
<h2 class="anchored" data-anchor-id="note">Note:</h2>
<p>It is possible to improve accuracy by determining</p>
</section>
<section id="run-topopyscale-in-colab" class="level1">
<h1>Run TopoPyScale in Colab</h1>
<p>Using TopoPyScale for downlading ERA-5 data seems be more difficult without VPN, in other hand connecting to VPN is not simple in my country, so after searching to find suitable method to running ToPoPyScale and downloading ERA-5 data without VPN, I found that the <code>Colab</code> is a good choice for this problem. In the following I tried to explain step-by-step in using TopoPyScale in Colab and then download data from google drive to local drive.</p>
<p>Open a new notebook in <code>https://colab.research.google.com/</code>. I used <code>nilick.gitcolab@gmail.com</code> account for this purpose.</p>
<section id="mount-the-google-drive" class="level3">
<h3 class="anchored" data-anchor-id="mount-the-google-drive">Mount the google drive</h3>
<p>some guides is from: https://netraneupane.medium.com/how-to-install-libraries-permanently-in-google-colab-fb15a585d8a5</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">"/content/drive"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-virtual-environment-using-virtualenv-library" class="level3">
<h3 class="anchored" data-anchor-id="create-a-virtual-environment-using-virtualenv-library">Create a virtual environment using virtualenv library</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install virtualenv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>virtualenv <span class="op">/</span>content<span class="op">/</span>drive<span class="op">/</span>MyDrive<span class="op">/</span>colab_env</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="activate-the-environment" class="level3">
<h3 class="anchored" data-anchor-id="activate-the-environment">Activate the environment</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>source <span class="op">/</span>content<span class="op">/</span>drive<span class="op">/</span>MyDrive<span class="op">/</span>colab_env<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>activate<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="install-packages" class="level3">
<h3 class="anchored" data-anchor-id="install-packages">Install Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install xarray matplotlib scikit<span class="op">-</span>learn pandas numpy netcdf4 h5netcdf rasterio pyproj dask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install topopyscale</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="test-package" class="level3">
<h3 class="anchored" data-anchor-id="test-package">Test Package</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> TopoPyScale <span class="im">import</span> topoclass <span class="im">as</span> tc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-up-cdsapi-1" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-cdsapi-1">Setting up cdsapi</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'url: https://cds.climate.copernicus.eu/api/v2'</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> <span class="st">'key: 2609:a8a3aba4-af46-4f7a-a79b-5799b58def50'</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'/root/.cdsapirc'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    f.write(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join([url, key]))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'/root/.cdsapirc'</span>) <span class="im">as</span> f:</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(f.read())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install cdsapi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">"/content/drive/MyDrive/colab_env/lib/python3.9/site-packages"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="running-topopyscale-in-colab" class="level3">
<h3 class="anchored" data-anchor-id="running-topopyscale-in-colab">Running TopoPyScale in Colab</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize Number of Clusters</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> TopoPyScale <span class="im">import</span> topoclass <span class="im">as</span> tc</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>config_file <span class="op">=</span> <span class="st">'/content/drive/MyDrive/topopyscale_run/config.yml'</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>mp <span class="op">=</span> tc.Topoclass(config_file)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>mp.compute_dem_param()</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">#df = mp.search_optimum_number_of_clusters(cluster_range=np.arange(100,1000,50),plot=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="local-google-drive" class="level3">
<h3 class="anchored" data-anchor-id="local-google-drive">Local Google Drive</h3>
<p>After running topopyscale in colab successfully, ERA-5 data are stored in google drive that these files must be transfer to local drive. One easy way for do this is using local google drive.</p>
<section id="access-google-drive-using-graphical-user-interface" class="level4">
<h4 class="anchored" data-anchor-id="access-google-drive-using-graphical-user-interface">Access Google Drive Using Graphical-User-Interface</h4>
<p><strong>Step 1: Open the settings</strong></p>
<p>To open the settings, go to the“Applications” and search the “Settings” in the search bar:</p>
<p><strong>Step 2: Select online accounts</strong></p>
<p>When the settings open, it will show the following interface. Now, select “Online Accounts”</p>
<p><strong>Step 3: Choose Google</strong></p>
<p>From the following window, choose“Google”</p>
<p><strong>Step 4: Allow for Gnome Trust</strong></p>
<p>After Enter the email &amp; password you should allow Gnome trust to continue with google drive. For this purpose, click on the “Allow” button</p>
<p><strong>Step 5: Sync Applications</strong></p>
<p>To sync the application with Google drive, choose the items that google drive will be used for</p>
<p><strong>Step 6: Using local Google drive</strong></p>
<p>open the <code>Home</code> directory and in left side open <code>Network</code> and then click on your google account to accessing your files.</p>
</section>
</section>
</section>
<section id="downscaling-for-large-area-and-big-data" class="level1">
<h1>Downscaling for large area and big data</h1>
<p>Netcdf file as the result of <code>Topopyscale</code> downscaling processing does not have <code>Latitude</code> and <code>Longitude</code> information and only has <code>point_id</code> data that is about cluster points id. Georeferencing the downscaled parameters is necessary for analysis and plotting. Fortunately, there is a file that has <code>Latitude</code> and <code>Longitude</code> data that was created during the downscaling process from <code>dem</code>. This file name is <code>ds_param</code>. In this file, we have a data variable name as <code>cluster_labels</code>. This data variable is the same as <code>point_id</code> in the downscaled file. Adding <code>cluster_labels</code> data to downscaled file can solve the georeferencing problem. Unfortunately, by adding this data when we want to save the new dataset as a new NetCDF file, it creates a huge file in size. For example for only one year hourly data such as 2000, doenscaled file size is ~35Mb but merged file size is ~3.5Gb! In <a href="https://stackoverflow.com/a/72116071/7717176">this URL</a> you can find the reason for this huge file creation.</p>
<p>I tried to solve this problem by reducing data variables, changing data type, and using different chunk sizes, but this approach did not impact significantly the file size. Finally, I decided to use the downscaled file with <code>ds_param</code> simultaneously.</p>
<p><strong>Note:</strong> In another prompet I tried use <code>Zarr</code> to save dataset but it build more larger than file than netcdf file.</p>
<p>For this purpose, I wrote below function for future use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> georef_down(downscaled_file, ds_param_file):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Taking files</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(downscaled_file, chunks<span class="op">=</span>{<span class="st">'time'</span>: <span class="dv">1000</span>})</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    ds_param <span class="op">=</span> xr.open_dataset(ds_param_file)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge Two Dataframe for adding (x,y)</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> dask.config.<span class="bu">set</span>(<span class="op">**</span>{<span class="st">'array.slicing.split_large_chunks'</span>: <span class="va">False</span>}):</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        ds_new <span class="op">=</span> ds.sel(point_id<span class="op">=</span>ds_param.cluster_labels)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename coordinate</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    ds_final <span class="op">=</span> ds_new.rename({<span class="st">'x'</span>: <span class="st">'Longitude'</span>,<span class="st">'y'</span>: <span class="st">'Latitude'</span>})</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    ds_final.Longitude.attrs[<span class="st">'units'</span>] <span class="op">=</span> <span class="st">'degrees_east'</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    ds_final.Latitude.attrs[<span class="st">'units'</span>] <span class="op">=</span> <span class="st">'degrees_north'</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop useless parameters</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    ds_droped_coor <span class="op">=</span> ds_final.drop([<span class="st">'reference_time'</span>, <span class="st">'point_id'</span>])</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    ds_droped_coor <span class="op">=</span> ds_final.drop([<span class="st">'reference_time'</span>, <span class="st">'point_id'</span>])</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    ds_droped_vars <span class="op">=</span> ds_droped_coor.drop_vars([<span class="st">'u'</span>, <span class="st">'v'</span>, <span class="st">'w'</span>, <span class="st">'cse'</span>,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">'SW_diffuse'</span>, <span class="st">'cos_illumination'</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">'SW_direct'</span>])</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rechunk</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    ds_rch <span class="op">=</span> ds_droped_vars.chunk(chunks<span class="op">=</span>{<span class="st">'Latitude'</span>: <span class="dv">200</span>, <span class="st">'Longitude'</span>: <span class="dv">250</span>,<span class="st">'time'</span>: <span class="dv">1024</span>})</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change dtypes</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    ds_rch[<span class="st">"Latitude"</span>] <span class="op">=</span> ds_rch[<span class="st">"Latitude"</span>].astype(<span class="st">"float32"</span>)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    ds_rch[<span class="st">"Longitude"</span>] <span class="op">=</span> ds_rch[<span class="st">"Longitude"</span>].astype(<span class="st">"float32"</span>)</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    variables <span class="op">=</span> <span class="bu">list</span>(ds_rch.keys())</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> variables:</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        ds_rch[var] <span class="op">=</span> ds_rch[var].astype(<span class="st">"float32"</span>)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ds_rch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>downscaled_file <span class="op">=</span> <span class="st">"...........~/downsale_yearly/outputs/zagros_era5_dwns_1km_2000.nc"</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>ds_param_file <span class="op">=</span> <span class="st">"............~/downsale_yearly/outputs/ds_param.nc"</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>ds_2000 <span class="op">=</span> georef_down(downscaled_file, ds_param_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can use above code for downscaling hourly data for each year and then combine yearly doenscaled datasets in Xarray.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>